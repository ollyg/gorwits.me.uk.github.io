<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<title>Internet accessible cats &#8211; part 2 | Cats and Code</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css" media="all" href="wp-content/themes/2010-weaver/style.css" />
<link rel="pingback" href="xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="Cats and Code &raquo; Feed" href="index.html%3Ffeed=rss2" />
<link rel="alternate" type="application/rss+xml" title="Cats and Code &raquo; Comments Feed" href="comments/feed/index.html" />

            <script type="text/javascript">//<![CDATA[
            // Google Analytics for WordPress by Yoast v4.3.3 | http://yoast.com/wordpress/google-analytics/
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-41472490-1']);
				            _gaq.push(['_trackPageview']);
            (function () {
                var ga = document.createElement('script');
                ga.type = 'text/javascript';
                ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';

                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(ga, s);
            })();
            //]]></script>
			<script type='text/javascript' src='http://blog.gorwits.me.uk/wp-includes/js/comment-reply.min.js?ver=3.6.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blog.gorwits.me.uk/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Internet accessible cats &#8211; Part 1' href='index.html%3Fp=834.html' />
<link rel='next' title='Winding Down' href='index.html%3Fp=924.html' />
<meta name="generator" content="WordPress 3.6.1" />
<link rel='canonical' href='index.html%3Fp=855.html' />
<link rel='shortlink' href='index.html%3Fp=855.html' />
<link rel="stylesheet" type="text/css" href="wp-content/plugins/wp-recaptcha/recaptcha.css" /><!-- This site is using 2010 Weaver V1.5.4 subtheme: Twenty Ten -->
<meta name="description" content=" Cats and Code - Hello, Welcome. " />
<meta name="keywords" content="Cats and Code blog, Cats and Code" />
<link rel="stylesheet" type="text/css" media="all" href="wp-content/blog.gorwits.me.uk/weaver-subthemes/style-weaver.css" />
<!-- Add your own CSS snippets between the style tags. -->
<style type="text/css">
</style>
<!-- End of Weaver options -->
<style type="text/css" id="syntaxhighlighteranchor"></style>
</head>

<body class="single single-post postid-855 single-format-standard">
<div id="wrapper" class="hfeed">

    
    <div id="header">
	<div id="masthead">
	    <div id="branding" role="banner">
		<div id="ttw-site-logo"></div>
		<div id="ttw-site-logo-link" onclick="location.href='http://blog.gorwits.me.uk/';" style="cursor:pointer;"></div>
				    		    <div id="site-title">
		    <span>
			<a href="index.html" title="Cats and Code" rel="home">Cats and Code</a>
		    </span>
		    </div>
		<div id="site-description">by Oliver Gorwits</div>
						
		<div id="access2" role="navigation">
		    <div class="skip-link screen-reader-text"><a href="index.html%3Fp=855.html#content" title="Skip to content">Skip to content</a></div>
		    
		</div><!-- #access2 -->

				
	    </div><!-- #branding -->
		
	    <div id="access" role="navigation">
		    		<div class="skip-link screen-reader-text"><a href="index.html%3Fp=855.html#content" title="Skip to content">Skip to content</a></div>

		    		    <div class="menu"><ul><li ><a href="index.html" title="Home">Home</a></li><li class="page_item page-item-13"><a href="about/index.html">About</a></li></ul></div>
	    </div><!-- #access -->
				
	</div><!-- #masthead -->
    </div><!-- #header -->

    
    <div id="main">

	<div id="container">
		    <div id="content" role="main">


		<div id="nav-above" class="navigation">
		    <div class="nav-previous"><a href="index.html%3Fp=834.html" rel="prev"><span class="meta-nav">&larr;</span> Internet accessible cats &#8211; Part 1</a></div>
		    <div class="nav-next"><a href="index.html%3Fp=924.html" rel="next">Winding Down <span class="meta-nav">&rarr;</span></a></div>
		</div><!-- #nav-above -->

		<div id="post-855" class="post-855 post type-post status-publish format-standard hentry category-cats category-linux category-networking category-transcoding category-video category-virtualization">
		    <h1 class="entry-title">Internet accessible cats &#8211; part 2</h1>
			<div class="entry-meta">
			    <span class="meta-prep meta-prep-author">Posted on</span> <a href="index.html%3Fp=855.html" title="22:08" rel="bookmark"><span class="entry-date">January 3, 2013</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="author/oliver/index.html" title="View all posts by Oliver Gorwits">Oliver Gorwits</a></span>			</div><!-- .entry-meta -->
			<div class="entry-content">
			    <p>So far so good for access to the new Cat Cam: from within the house we can view video from the cats&#8217; shed, yet the camera is safely on its own DMZ.</p>
<p>In this final post I&#8217;ll show how I made the camera video feed available on the Internet.</p>
<p>One thing I wanted from the outset was for Internet clients not to make direct connections to the camera itself. I was a little worried about the ability of the web server and CPU in the camera to cope with multiple clients, and also the security implications of direct access. A second requirement was to have multi platform access &#8211; that is, desktop and iOS. This potentially means different streaming video formats.</p>
<p>We have one linux server in the house, which is used for many different things and runs <a href="index.html%3Fp=728.html"  target="_blank">virtual machines</a>. My back-of-an-envelope plan looked something like this:</p>
<p><a href="2013/01/03/internet-accessible-cats-part-2/cat-internet-3/index.html"  rel="attachment wp-att-858"><img class="aligncenter size-full wp-image-858" title="cat-internet" src="wp-content/blog.gorwits.me.uk/2012/12/cat-internet2.png" alt="" width="250" height="382" /></a></p>
<p>First step was to create the VM, but remember that the camera feed is in a DMZ using a VLAN, so the VM must live there too. In KVM it&#8217;s possible either to send all traffic to a guest system and let it process the VLANs or, you can separate the tagged VLAN traffic in the host system so the guest is dumb and just sees untagged frames. Clearly the latter is preferable so that were the guest to suffer attack from the Internet, it ought not to be able to put traffic onto the house workstation network. The guest is completely within the DMZ.</p>
<p>With that done and a basic Ubuntu system installed, I started work on Apache and <a href="http://www.videolan.org/vlc/index.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.videolan.org']);" target="_blank">VLC</a> (the Swiss Army Chainsaw of video processing). First up, VLC&#8230;</p>
<p>Luckily the camera&#8217;s video feed comes in MJPEG format with a discoverable URL. The idea is to take this feed, duplicate it, and transcode the respective feeds into something suitable for a desktop browser and for iOS. As a bonus, I&#8217;ll timestamp the video to make it easy to tell if the transcoder has crashed (the timestamp would be wrong). After a <em>lot</em> of reading online about how to configure VLC I came up with the following monstrosity:</p>
<pre class="brush: plain; title: ; notranslate" title="">
/usr/bin/cvlc -I dummy http://guest:guest@172.16.30.10:8888/videostream.cgi?rate=0
  --sout='#duplicate{

    dst=&quot;transcode{
      width=320,heigh=240,fps=25,vcodec=h264,vb=256,acodec=none,
      venc=x264{profile=baseline,level=30,keyint=30,ref=1},
      sfilter=marq{marquee=\&quot;[%Y-%m-%d %H:%M:%S]\&quot;,position=8,size=18}
    }:std{access=livehttp{
        seglen=10,delsegs=true,numsegs=5,
        index=/var/www/streaming/cats.m3u8,
        index-url=/streaming/cats-########.ts},
      mux=ts{use-key-frames},
      dst=/var/www/streaming/cats-########.ts}&quot;,

    dst=&quot;transcode{
      width=640,heigh=480,fps=25,vcodec=theo,vb=512,acodec=none,
      sfilter=marq{marquee=\&quot;[%Y-%m-%d %H:%M:%S]\&quot;,position=8,size=18}
    }:http{mux=ogg,dst=127.0.0.1:8081/catcam.ogg}&quot;

  }'
</pre>
<p>Of the two transcodes (&#8220;dst=&#8221;), the second is more straightforward. It creates an <a href="http://en.wikipedia.org/wiki/Ogg" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://en.wikipedia.org']);" target="_blank">Ogg</a> format stream using the <a href="http://en.wikipedia.org/wiki/Theora" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://en.wikipedia.org']);" target="_blank">Theora</a> video codec, which modern browsers should be able to cope with. This is a video stream being served from VLC&#8217;s built-in web server, so I&#8217;ll need to proxy it via Apache. The configuration also applies a filter (&#8220;sfilter=&#8221;) to add a timestamp on the video stream.</p>
<p>The first transcode uses the new <a href="https://developer.apple.com/resources/http-streaming/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://developer.apple.com']);" target="_blank">HTTP Live Streaming</a> support in VLC. This is a rather elegant specification from Apple (which is why I selected it for the iOS clients) for simple and efficient delivery of streaming video. It creates a set of files and assumes you have a web server to serve them. The files each contain a few seconds of video, and the client retrieves them and plays one after another. The &#8220;######&#8221; templates an incrementing number within the segment filename. Again, the timestamp is added to the video stream.</p>
<p>CPU load for the above runs at about 60% (in the VM) on the dual core Athlon X2 245e processor. I wrapped the above in an <a href="http://upstart.ubuntu.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://upstart.ubuntu.com']);" target="_blank">Upstart</a> init file, and just in case VLC gets its knickers in a twist, I added a cron job to periodically stop and start the service.</p>
<p>Now on to Apache. It needs to proxy the Ogg stream and serve the Live Streaming files, and prevent any other access to the web server:</p>
<pre class="brush: plain; title: ; notranslate" title="">
# redirect any non-cat requests to the cat index.html
RewriteEngine on
RewriteCond %{REQUEST_URI} !^/streaming/cats.*
RewriteCond %{REQUEST_URI} !^/stream/catcam.ogg$
RewriteCond %{REQUEST_URI} !^/index.html$
RewriteRule ^(.*) http://%{HTTP_HOST}/index.html [R,L]

ProxyReceiveBufferSize 16384
ProxyRequests On
ProxyVia On
ProxyPreserveHost On

&lt;Proxy *&gt;
    Order deny,allow
    Allow from all
&lt;/Proxy&gt;

# VLC server stream
ProxyPass /stream/catcam.ogg http://localhost:8081/catcam.ogg
ProxyPassReverse /stream/catcam.ogg http://localhost:8081/catcam.ogg
</pre>
<p>Last but not least for this server, we need a web page which offers up the two video streams. This uses an HTML5 video tag:</p>
<pre class="brush: xml; title: ; notranslate" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Cat Cam&lt;/title&gt;
        &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;
        &lt;META HTTP-EQUIV=&quot;Pragma&quot; CONTENT=&quot;no-cache&quot;&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Cat Cam&lt;/h1&gt;
        &lt;video id=&quot;video&quot; autoplay=&quot;autoplay&quot;&gt;
            &lt;source src=&quot;/streaming/cats.m3u8&quot;&gt;
            &lt;source src=&quot;/stream/catcam.ogg&quot; type=&quot;video/ogg; codecs=theora&quot;&gt;
            Your browser doesn't appear to support the HTML5 &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; element.
        &lt;/video&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>All that remains is to enable a NAT rule and firewall pinhole on the home router for the web server (which is, of course, in the DMZ network connected directly to the router).</p>
<p>Let&#8217;s see the end result, taken on my iPhone this evening, also demonstrating the automatically activated night vision mode:</p>
<p><a href="2013/01/03/internet-accessible-cats-part-2/cat-ngith/index.html"  rel="attachment wp-att-884"><img class="aligncenter size-full wp-image-884" title="cat-ngith" src="wp-content/blog.gorwits.me.uk/2012/12/cat-ngith.png" alt="" width="400" height="267" /></a></p>
<p>It&#8217;s nice to be able to check in on the wee beasties when I&#8217;m out at work. Other than a lot of reading about VLC, it wasn&#8217;t particularly difficult to do, and I think the end result is really quite good.</p>
			    			</div><!-- .entry-content -->


		<div class="entry-utility">
		    This entry was posted in <a href="category/cats/index.html" title="View all posts in cats" rel="category tag">cats</a>, <a href="category/linux/index.html" title="View all posts in linux" rel="category tag">linux</a>, <a href="category/networking/index.html" title="View all posts in networking" rel="category tag">networking</a>, <a href="category/transcoding/index.html" title="View all posts in transcoding" rel="category tag">transcoding</a>, <a href="category/video/index.html" title="View all posts in video" rel="category tag">video</a>, <a href="category/virtualization/index.html" title="View all posts in virtualization" rel="category tag">virtualization</a>. Bookmark the <a href="index.html%3Fp=855.html" title="Permalink to Internet accessible cats &#8211; part 2" rel="bookmark">permalink</a>.		    		</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		<div id="nav-below" class="navigation">
		    <div class="nav-previous"><a href="index.html%3Fp=834.html" rel="prev"><span class="meta-nav">&larr;</span> Internet accessible cats &#8211; Part 1</a></div>
		    <div class="nav-next"><a href="index.html%3Fp=924.html" rel="next">Winding Down <span class="meta-nav">&rarr;</span></a></div>
		</div><!-- #nav-below -->

		
			<div id="comments">


	<p class="nocomments">Comments are closed.</p>


								
</div><!-- #comments -->


	    </div><!-- #content -->
	</div><!-- #container -->

	<div id="primary" class="widget-area" role="complementary">
	    <ul class="xoxo">

<li id="search-2" class="widget-container widget_search"><form role="search" method="get" id="searchform" class="searchform" action="index.html">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s" />
					<input type="submit" id="searchsubmit" value="Search" />
				</div>
			</form></li><li id="archives-2" class="widget-container widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
			<li><a href='2014/03/index.html' title='March 2014'>March 2014</a></li>
	<li><a href='2013/01/index.html' title='January 2013'>January 2013</a></li>
	<li><a href='2012/12/index.html' title='December 2012'>December 2012</a></li>
	<li><a href='2012/09/index.html' title='September 2012'>September 2012</a></li>
	<li><a href='2012/08/index.html' title='August 2012'>August 2012</a></li>
	<li><a href='2012/06/index.html' title='June 2012'>June 2012</a></li>
	<li><a href='2012/04/index.html' title='April 2012'>April 2012</a></li>
	<li><a href='2012/01/index.html' title='January 2012'>January 2012</a></li>
	<li><a href='2011/11/index.html' title='November 2011'>November 2011</a></li>
	<li><a href='2011/10/index.html' title='October 2011'>October 2011</a></li>
	<li><a href='2011/09/index.html' title='September 2011'>September 2011</a></li>
	<li><a href='2011/08/index.html' title='August 2011'>August 2011</a></li>
	<li><a href='2011/07/index.html' title='July 2011'>July 2011</a></li>
	<li><a href='2011/06/index.html' title='June 2011'>June 2011</a></li>
	<li><a href='2011/05/index.html' title='May 2011'>May 2011</a></li>
	<li><a href='2011/04/index.html' title='April 2011'>April 2011</a></li>
	<li><a href='2011/03/index.html' title='March 2011'>March 2011</a></li>
	<li><a href='2011/02/index.html' title='February 2011'>February 2011</a></li>
	<li><a href='2011/01/index.html' title='January 2011'>January 2011</a></li>
	<li><a href='2010/11/index.html' title='November 2010'>November 2010</a></li>
	<li><a href='2010/09/index.html' title='September 2010'>September 2010</a></li>
		</ul>
</li><li id="categories-2" class="widget-container widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-6"><a href="category/blogging/index.html" title="View all posts filed under blogging">blogging</a>
</li>
	<li class="cat-item cat-item-28"><a href="category/cats/index.html" title="View all posts filed under cats">cats</a>
</li>
	<li class="cat-item cat-item-16"><a href="category/databases/index.html" title="View all posts filed under databases">databases</a>
</li>
	<li class="cat-item cat-item-13"><a href="category/devops/index.html" title="View all posts filed under devops">devops</a>
</li>
	<li class="cat-item cat-item-21"><a href="category/git/index.html" title="View all posts filed under git">git</a>
</li>
	<li class="cat-item cat-item-7"><a href="category/htpc/index.html" title="View all posts filed under htpc">htpc</a>
</li>
	<li class="cat-item cat-item-24"><a href="category/kerberos/index.html" title="View all posts filed under kerberos">kerberos</a>
</li>
	<li class="cat-item cat-item-8"><a href="category/linux/index.html" title="View all posts filed under linux">linux</a>
</li>
	<li class="cat-item cat-item-19"><a href="category/monitoring/index.html" title="View all posts filed under monitoring">monitoring</a>
</li>
	<li class="cat-item cat-item-11"><a href="category/mythtv/index.html" title="View all posts filed under mythtv">mythtv</a>
</li>
	<li class="cat-item cat-item-20"><a href="category/netdisco/index.html" title="View all posts filed under netdisco">netdisco</a>
</li>
	<li class="cat-item cat-item-10"><a href="category/networking/index.html" title="View all posts filed under networking">networking</a>
</li>
	<li class="cat-item cat-item-27"><a href="category/opinion/index.html" title="View all posts filed under opinion">opinion</a>
</li>
	<li class="cat-item cat-item-18"><a href="category/os-x/index.html" title="View all posts filed under OS X">OS X</a>
</li>
	<li class="cat-item cat-item-9"><a href="category/perl/index.html" title="View all posts filed under perl">perl</a>
</li>
	<li class="cat-item cat-item-17"><a href="category/personal/index.html" title="View all posts filed under personal">personal</a>
</li>
	<li class="cat-item cat-item-22"><a href="category/productivity/index.html" title="View all posts filed under productivity">productivity</a>
</li>
	<li class="cat-item cat-item-15"><a href="category/python/index.html" title="View all posts filed under python">python</a>
</li>
	<li class="cat-item cat-item-14"><a href="category/radius/index.html" title="View all posts filed under radius">radius</a>
</li>
	<li class="cat-item cat-item-26"><a href="category/sysops/index.html" title="View all posts filed under sysops">sysops</a>
</li>
	<li class="cat-item cat-item-12"><a href="category/transcoding/index.html" title="View all posts filed under transcoding">transcoding</a>
</li>
	<li class="cat-item cat-item-29"><a href="category/video/index.html" title="View all posts filed under video">video</a>
</li>
	<li class="cat-item cat-item-23"><a href="category/virtualization/index.html" title="View all posts filed under virtualization">virtualization</a>
</li>
	<li class="cat-item cat-item-25"><a href="category/windows/index.html" title="View all posts filed under windows">windows</a>
</li>
		</ul>
</li><li id="syndication" class="widget-container Syndication_widget_syndication_widget"><h3 class="widget-title">Syndication</h3><ul>
<li>
<a  title='RSS Feed' href='index.html%3Ffeed=rss2'/>RSS</a></li>
<li>
<a title='ATOM Feed' href='index.html%3Ffeed=atom'/>ATOM</a></li>
<li>
<a title='POML Feed' href='wp-links-opml.php'/>OPML</a></li>
</ul>
</li>			</ul>
	</div><!-- #primary .widget-area -->

    </div><!-- #main -->
        	<div id="footer">
		<div id="colophon">

<table id='ttw_ftable'><tr>
 <td id='ttw_ftdl'><div id="site-info">
 &copy; 2014 - <a href="index.html" title="Cats and Code" rel="home">Cats and Code</a>
 </div></td>  <td id='ttw_ftdr'><div id="site-generator">
  <a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">Proudly powered by WordPress.</a>
 2010 Weaver by WPWeaver.info
 </div></td> </tr></table>
		</div><!-- #colophon -->
	</div><!-- #footer -->
            
</div><!-- #wrapper -->

<script type='text/javascript' src='wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js%3Fver=3.0.83c'></script>
<script type='text/javascript' src='wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPlain.js%3Fver=3.0.83c'></script>
<script type='text/javascript' src='wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js%3Fver=3.0.83c'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://blog.gorwits.me.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83c";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://blog.gorwits.me.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83c";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['auto-links'] = false;
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.defaults['wrap-lines'] = false;
	SyntaxHighlighter.all();
</script>
</body>
</html>
